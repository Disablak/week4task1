- name: Template .env file
  template:
    src: env.j2
    dest: /opt/myapp/.env
    owner: ec2-user
    group: ec2-user
    mode: '0755'

- name: Run syncdb on the application
  community.general.django_manage:
    command: migrate
    project_path: /opt/myapp
    virtualenv: /opt/myapp/venv
  when: "'web-db-migrate' in group_names"

- name: Create an initial superuser
  community.general.django_manage:
    command: "createsuperuser --noinput"
    project_path: /opt/myapp
    virtualenv: /opt/myapp/venv
  when: "'web-db-migrate' in group_names"

- name: Run Django collectstatic
  community.general.django_manage:
    command: collectstatic --noinput
    project_path: /opt/myapp
    virtualenv: /opt/myapp/venv

- name: Restart gunicorn service
  systemd:
    name: gunicorn
    state: restarted

- name: Restart nginx service
  systemd:
    name: nginx
    state: restarted