- name: Template .env file
  template:
    src: env.j2
    dest: /opt/myapp/.env
    owner: ec2-user
    group: ec2-user
    mode: '0755'

# i know using shell is bad
- name: Run Django migrate with environment
  shell:
    python /opt/myapp/manage.py migrate
  environment:
    PATH: "/opt/myapp/venv/bin:{{ ansible_env.PATH }}"
    VIRTUAL_ENV: "/opt/myapp/venv"
  when: "'web-db-migrate' in group_names"

# i know using shell is bad
- name: Create Django superuser non-interactively
  shell: |
    echo "
    from django.contrib.auth import get_user_model
    User = get_user_model()
    if not User.objects.filter(username='{{ site_superuser_login }}').exists():
        User.objects.create_superuser('{{ site_superuser_login }}', '{{ site_superuser_mail }}', '{{ site_superuser_password }}')
    " | python manage.py shell
  args:
    chdir: /opt/myapp
  environment:
    PATH: "/opt/myapp/venv/bin:{{ ansible_env.PATH }}"
    VIRTUAL_ENV: "/opt/myapp/venv"
  when: "'web-db-migrate' in group_names"

- name: Run Django collectstatic
  community.general.django_manage:
    command: collectstatic --noinput
    project_path: /opt/myapp
    virtualenv: /opt/myapp/venv

- name: Restart gunicorn service
  systemd:
    name: gunicorn
    state: restarted

- name: Restart nginx service
  systemd:
    name: nginx
    state: restarted