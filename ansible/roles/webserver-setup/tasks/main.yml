---
- name: Update yum cache
  yum:
    update_cache: yes

- name: Install system packages
  dnf:
    name:
      - python3
      - python3-pip
#      - python3-venv
      - nginx
    state: present

- name: Create app directory
  file:
    path: /opt/myapp
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: u=rwx,g=rx,o=rx

- name: Copy myapp files
  copy:
    src: "{{ playbook_dir }}/../myapp/"
    dest: /opt/myapp/
    owner: ec2-user
    group: ec2-user

- name: Install Python requirements
  pip:
    requirements: "/opt/myapp/requirements.txt"
#    virtualenv: /opt/myapp/venv
    executable: pip3

- name: Create systemd service for Django
  template:
    src: django.service.j2
    dest: /etc/systemd/system/myapp.service
  notify: restart django

- name: Start Django service
  systemd:
    name: myapp
    enabled: yes
    state: started

- name: Configure nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/myapp.conf
    owner: ec2-user
    group: ec2-user
    mode: '0644'
  notify: reload nginx

- name: Ensure Nginx is started and enabled
  service:
    name: nginx
    state: started
    enabled: true

# - name: Enable nginx site
#   file:
#     src: /etc/nginx/sites-available/myapp
#     dest: /etc/nginx/sites-enabled/myapp
#     state: link

# - name: Remove default nginx config
#   file:
#     path: /etc/nginx/sites-enabled/default
#     state: absent
